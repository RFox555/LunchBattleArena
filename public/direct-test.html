<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Direct API Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2 {
      margin-top: 20px;
      color: #333;
    }
    button, input, textarea {
      font-family: inherit;
      font-size: 16px;
      padding: 8px 12px;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 15px;
      cursor: pointer;
    }
    button:hover {
      background: #4338ca;
    }
    form {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #f9f9f9;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
    }
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
    }
    .hidden {
      display: none;
    }
    #auth-status {
      font-weight: bold;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Direct API Test</h1>
  
  <div id="auth-status">Checking authentication...</div>
  
  <div id="login-form" class="hidden">
    <h2>Login</h2>
    <form id="login">
      <div>
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" value="driver1" required>
      </div>
      <div>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" value="password123" required>
      </div>
      <div>
        <label for="userType">User Type:</label>
        <select id="userType" name="userType" required>
          <option value="driver" selected>Driver</option>
          <option value="rider">Rider</option>
        </select>
      </div>
      <button type="submit">Login</button>
    </form>
  </div>
  
  <div id="check-in-form" class="hidden">
    <h2>Check-In Rider</h2>
    <form id="check-in">
      <div>
        <label for="riderId">Rider ID:</label>
        <input type="text" id="riderId" name="riderId" value="12345" required>
      </div>
      <div>
        <label for="location">Location:</label>
        <input type="text" id="location" name="location" value="Bus Stop" required>
      </div>
      <div>
        <label for="note">Note:</label>
        <textarea id="note" name="note" rows="3">Test note</textarea>
      </div>
      <button type="submit">Create Trip</button>
    </form>
  </div>
  
  <div id="result" class="hidden"></div>
  
  <h2>API Testing Buttons</h2>
  <div>
    <button id="get-user">Get Current User</button>
    <button id="get-trips">Get My Trips</button>
    <button id="get-riders">Get Riders</button>
    <button id="logout">Logout</button>
  </div>
  
  <script>
    // DOM references
    const authStatus = document.getElementById('auth-status');
    const loginForm = document.getElementById('login-form');
    const checkInForm = document.getElementById('check-in-form');
    const resultDiv = document.getElementById('result');
    
    // Helper Functions
    function showResult(data, isSuccess = true) {
      resultDiv.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
      resultDiv.className = isSuccess ? 'result success' : 'result error';
      resultDiv.classList.remove('hidden');
    }
    
    function showError(error) {
      resultDiv.textContent = error.message || 'An error occurred';
      resultDiv.className = 'result error';
      resultDiv.classList.remove('hidden');
    }
    
    // Authentication check
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        if (response.ok) {
          const user = await response.json();
          authStatus.textContent = `Logged in as ${user.name} (${user.userType})`;
          authStatus.style.color = 'green';
          loginForm.classList.add('hidden');
          checkInForm.classList.remove('hidden');
        } else {
          authStatus.textContent = 'Not logged in';
          authStatus.style.color = 'red';
          loginForm.classList.remove('hidden');
          checkInForm.classList.add('hidden');
        }
      } catch (error) {
        authStatus.textContent = 'Error checking authentication';
        authStatus.style.color = 'red';
        showError(error);
      }
    }
    
    // Login handling
    document.getElementById('login').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const loginData = {
          username: formData.get('username'),
          password: formData.get('password'),
          userType: formData.get('userType')
        };
        
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(loginData),
          credentials: 'include'
        });
        
        if (response.ok) {
          const user = await response.json();
          showResult(`Successfully logged in as ${user.name}`);
          checkAuth();
        } else {
          const error = await response.json();
          showResult(error.message || 'Login failed', false);
        }
      } catch (error) {
        showError(error);
      }
    });
    
    // Check-in handling
    document.getElementById('check-in').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const checkInData = {
          riderId: formData.get('riderId'),
          location: formData.get('location'),
          note: formData.get('note')
        };
        
        const response = await fetch('/api/trips', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(checkInData),
          credentials: 'include'
        });
        
        const responseText = await response.text();
        let data;
        
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          data = responseText;
        }
        
        if (response.ok) {
          showResult({
            message: 'Check-in successful!',
            trip: data
          });
        } else {
          showResult({
            message: 'Check-in failed',
            error: data,
            status: response.status
          }, false);
        }
      } catch (error) {
        showError(error);
      }
    });
    
    // API Test Buttons
    document.getElementById('get-user').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        const data = await response.json();
        showResult(data, response.ok);
      } catch (error) {
        showError(error);
      }
    });
    
    document.getElementById('get-trips').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/trips', { credentials: 'include' });
        const data = await response.json();
        showResult(data, response.ok);
      } catch (error) {
        showError(error);
      }
    });
    
    document.getElementById('get-riders').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/users?userType=rider', { credentials: 'include' });
        const data = await response.json();
        showResult(data, response.ok);
      } catch (error) {
        showError(error);
      }
    });
    
    document.getElementById('logout').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        const data = await response.json();
        showResult(data, response.ok);
        if (response.ok) {
          checkAuth();
        }
      } catch (error) {
        showError(error);
      }
    });
    
    // Initial auth check
    checkAuth();
  </script>
</body>
</html>