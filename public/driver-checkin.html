<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transportation Tracking System - Driver Check-In</title>
  <!-- Ensure HTML extension -->
  <script src="/js/ensure-extension.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      font-size: 32px;
      margin-right: 10px;
    }
    .heading {
      display: flex;
      align-items: center;
    }
    .nav-links {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    .nav-link {
      text-decoration: none;
      background-color: #2563eb;
      color: white;
      padding: 8px 16px;
      border-radius: 5px;
      font-weight: 500;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .nav-link:hover {
      background-color: #1d4ed8;
    }
    h1 {
      margin: 0;
      color: #2563eb;
      font-size: 24px;
    }
    .logout-button {
      background-color: #f3f4f6;
      color: #4b5563;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .welcome {
      font-size: 18px;
      margin-bottom: 15px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    .tab.active {
      border-bottom-color: #2563eb;
      color: #2563eb;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .scanner-container {
      margin: 20px 0;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 8px;
      overflow: hidden;
    }
    .button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 0;
    }
    .button:hover {
      background-color: #1d4ed8;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    .success-message {
      background-color: #dcfce7;
      border: 1px solid #86efac;
      color: #166534;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
    .error-message {
      background-color: #fee2e2;
      border: 1px solid #fca5a5;
      color: #b91c1c;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
    .trip-details {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      display: none;
    }
    .detail-row {
      margin-bottom: 8px;
    }
    .detail-label {
      font-weight: bold;
      display: inline-block;
      width: 120px;
    }
    .recent-check-ins {
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th {
      text-align: left;
      border-bottom: 2px solid #e5e7eb;
      padding: 10px 15px;
      font-size: 14px;
      color: #6b7280;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .no-trips {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      font-style: italic;
    }
    .status-indicator {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .status-indicator.active {
      background-color: #dcfce7;
      color: #166534;
    }
    .status-indicator.inactive {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .status-icon {
      font-size: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
    }
    .status-icon.active {
      color: #166534;
    }
    .status-icon.inactive {
      color: #b91c1c;
    }
    .status-text {
      font-size: 18px;
    }
    .status-text.active {
      color: #166534;
    }
    .status-text.inactive {
      color: #b91c1c;
    }
    .driver-status-panel.loading {
      opacity: 0.7;
    }
    .driver-status-panel.checked-in {
      border-left: 5px solid #10b981;
    }
    .driver-status-panel.checked-out {
      border-left: 5px solid #ef4444;
    }
    .location-tracking {
      margin-top: 20px;
    }
    .location-status-container {
      margin: 15px 0;
      text-align: center;
    }
  </style>
  <!-- No scripts here - all scripts are at the end of the body -->
</head>
<body>
  <div class="container">
    <header>
      <div class="heading">
        <div class="logo">ðŸšŒ</div>
        <div>
          <h1>Transportation Tracking System</h1>
          <h2 style="margin-top: 5px; font-size: 16px; color: #4b5563;">Driver Check-In</h2>
          <div class="nav-links">
            <a href="/driver-checkin.html" class="nav-link">Check-In</a>
            <a href="/driver-ratings.html" class="nav-link">My Ratings</a>
            <a href="/bus-tracking.html" class="nav-link">Bus Map</a>
          </div>
        </div>
      </div>
      <button id="logout-button" class="logout-button">Logout</button>
    </header>

    <div class="card">
      <div id="welcome-message" class="welcome">Loading...</div>
      
      <!-- Driver Check-in/Check-out Panel -->
      <div id="driver-status-panel" class="driver-status-panel" style="margin-bottom: 20px; padding: 15px; background-color: #f3f4f6; border-radius: 8px;">
        <h3 style="margin-top: 0;">Driver Status</h3>
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
          <div id="status-icon" class="status-icon inactive" style="margin-right: 10px;">
            <i class="fas fa-times-circle"></i>
          </div>
          <div id="status-text" class="status-text inactive" style="font-weight: bold; font-size: 18px;">
            Checking status...
          </div>
          <div id="status-loading" style="display: block; margin-left: 10px;">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </div>
        
        <div style="margin-bottom: 15px; padding: 10px; background-color: #eff6ff; border-radius: 5px;">
          <div style="display: flex; justify-content: space-between;">
            <div>
              <strong>Driver:</strong> <span id="driver-name">Loading...</span>
            </div>
            <button id="btn-refresh-status" class="refresh-button" style="background: none; border: none; color: #2563eb; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div style="margin-top: 8px;">
            <strong>Last Check-in:</strong> <span id="last-check-in-time">N/A</span>
          </div>
          <div style="margin-top: 3px;">
            <strong>Last Check-out:</strong> <span id="last-check-out-time">N/A</span>
          </div>
        </div>
        
        <!-- Check-in form (shown when checked out) -->
        <div id="check-in-form" style="display: none;">
          <p>You must check in before you can scan employee QR codes.</p>
          <div class="form-group">
            <label for="check-in-location">Current Location:</label>
            <input type="text" id="check-in-location" value="Bus Terminal" required>
          </div>
          <div class="form-group">
            <label for="check-in-note">Note (Optional):</label>
            <textarea id="check-in-note" placeholder="Add any notes about your shift"></textarea>
          </div>
          <div style="display: flex; justify-content: center;">
            <button id="btn-check-in" class="button">Start Shift (Check In)</button>
          </div>
        </div>
        
        <!-- Check-out form (shown when checked in) -->
        <div id="check-out-form" style="display: none;">
          <p>You are currently checked in and ready to scan employee QR codes.</p>
          <div class="form-group">
            <label for="check-out-note">Check-out Note (Optional):</label>
            <textarea id="check-out-note" placeholder="Add any notes about your completed shift"></textarea>
          </div>
          <div style="display: flex; justify-content: center;">
            <button id="btn-check-out" class="button" style="background-color: #e11d48;">End Shift (Check Out)</button>
          </div>
        </div>
      </div>
      
      <!-- Message container for alerts -->
      <div id="message-container" style="margin-bottom: 20px;"></div>
      
      <div id="scanning-panel">
        <div class="tabs">
          <div class="tab active" data-tab="scan">Scan QR Code</div>
          <div class="tab" data-tab="manual">Manual Entry</div>
        </div>
      
      <div id="scan-tab" class="tab-content active">
        <p>Scan the employee's QR code to check them in:</p>
        <div class="scanner-container">
          <div id="reader"></div>
          <button id="start-scan" class="button">Start Scanner</button>
          <button id="stop-scan" class="button" style="display:none; background-color: #e11d48;">Stop Scanner</button>
          
          <div style="margin-top: 20px; text-align: center;">
            <p>If camera access is not available, you can manually enter the Employee ID below:</p>
            <div style="display: flex; max-width: 300px; margin: 0 auto;">
              <input type="text" id="qr-manual-input" placeholder="Enter Employee ID" style="margin-right: 10px;">
              <button id="qr-manual-submit" class="button" style="width: auto; margin: 0;">Submit</button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="manual-tab" class="tab-content">
        <form id="check-in-form">
          <div class="form-group">
            <label for="employee-id">Employee ID:</label>
            <input type="text" id="employee-id" name="riderId" maxlength="5" pattern="[0-9]{5}" placeholder="Enter 5-digit employee ID" required>
          </div>
          
          <div class="form-group">
            <label for="location">Pickup Location:</label>
            <input type="text" id="location" name="location" value="Bus Stop" required>
          </div>
          
          <div class="form-group">
            <label for="note">Note (Optional):</label>
            <textarea id="note" name="note" placeholder="Add any notes about this trip"></textarea>
          </div>
          
          <button type="submit" class="button">Check In Employee</button>
        </form>
      </div>
      
      <div id="success-message" class="success-message"></div>
      <div id="error-message" class="error-message"></div>
      
      <div id="trip-details" class="trip-details">
        <h2>Trip Details</h2>
        <div class="detail-row">
          <span class="detail-label">Trip ID:</span>
          <span id="trip-id"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Employee ID:</span>
          <span id="trip-employee"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Location:</span>
          <span id="trip-location"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span id="trip-time"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Note:</span>
          <span id="trip-note"></span>
        </div>
      </div>
      </div>
    </div>
    
    <div class="card recent-check-ins">
      <h2>Recent Check-Ins</h2>
      <div id="trips-container">
        <div class="no-trips">Loading recent check-ins...</div>
      </div>
    </div>
    
    <div class="card location-tracking">
      <h2>Bus Location Tracking</h2>
      <p>Enable location sharing to help employees track your bus:</p>
      
      <div class="location-status-container" style="margin: 15px 0; text-align: center;">
        <div id="locationStatus" class="status-indicator inactive" 
             style="display: inline-block; padding: 10px 15px; border-radius: 4px; font-weight: bold;">
          Tracking Inactive
        </div>
      </div>
      
      <div class="form-group">
        <label for="routeName">Route Name:</label>
        <input type="text" id="routeName" placeholder="Enter route name (e.g., Main St to Downtown)">
      </div>
      
      <div class="form-group">
        <label for="driverStatus">Status:</label>
        <select id="driverStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
          <option value="active">Active - On Route</option>
          <option value="break">On Break</option>
          <option value="inactive">Inactive - Off Duty</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="startTracking" class="button" style="flex: 1;">Start Location Tracking</button>
        <button id="stopTracking" class="button" style="flex: 1; background-color: #e11d48;" disabled>Stop Tracking</button>
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background-color: #f3f4f6; border-radius: 4px;">
        <p style="font-size: 14px; margin: 0;">
          <strong>Note:</strong> Location data will be updated automatically while tracking is active.
          Your bus position will be visible on the <a href="/bus-tracking.html" target="_blank" style="color: #2563eb;">Bus Tracking Map</a>.
        </p>
      </div>
    </div>
  </div>
  
  <script>
    // DOM elements
    const welcomeMessage = document.getElementById('welcome-message');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const scanTab = document.getElementById('scan-tab');
    const manualTab = document.getElementById('manual-tab');
    const checkInForm = document.getElementById('check-in-form');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const tripDetails = document.getElementById('trip-details');
    const tripId = document.getElementById('trip-id');
    const tripEmployee = document.getElementById('trip-employee');
    const tripLocation = document.getElementById('trip-location');
    const tripTime = document.getElementById('trip-time');
    const tripNote = document.getElementById('trip-note');
    const tripsContainer = document.getElementById('trips-container');
    const logoutButton = document.getElementById('logout-button');
    const startScanButton = document.getElementById('start-scan');
    const stopScanButton = document.getElementById('stop-scan');
    const qrManualInput = document.getElementById('qr-manual-input');
    const qrManualSubmit = document.getElementById('qr-manual-submit');
    
    // Driver check-in/check-out elements
    const driverStatusIndicator = document.getElementById('driver-status-indicator');
    const driverCheckedInControls = document.getElementById('driver-checked-in-controls');
    const driverCheckedOutControls = document.getElementById('driver-checked-out-controls');
    const driverCheckInBtn = document.getElementById('driver-check-in-btn');
    const driverCheckOutBtn = document.getElementById('driver-check-out-btn');
    const checkInLocation = document.getElementById('check-in-location');
    const checkInNote = document.getElementById('check-in-note');
    const checkInTimeDisplay = document.getElementById('check-in-time');
    const scanningPanel = document.getElementById('scanning-panel');
    
    // Current user data
    let currentUser = null;
    // NOTE: Driver status is now managed by driver-checkin.js
    
    // QR Code scanner
    let html5QrCode;
    let isScanning = false;
    
    // Format date and time
    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString();
    }
    
    // Initialize QR Code scanner
    function initQrScanner() {
      html5QrCode = new Html5Qrcode("reader");
      
      startScanButton.addEventListener('click', startScanner);
      stopScanButton.addEventListener('click', stopScanner);
    }
    
    // Start scanner
    function startScanner() {
      // First, make sure the driver is checked in
      // Using the global function from driver-checkin.js
      if (!window.isDriverCheckedIn()) {
        errorMessage.textContent = 'You must check in before you can scan employee QR codes.';
        errorMessage.style.display = 'block';
        return;
      }
      
      const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };
      
      html5QrCode.start(
        { facingMode: "environment" },
        qrConfig,
        onScanSuccess,
        onScanFailure
      )
      .then(() => {
        isScanning = true;
        startScanButton.style.display = 'none';
        stopScanButton.style.display = 'block';
      })
      .catch(err => {
        console.error('Failed to start scanner:', err);
        errorMessage.textContent = 'Failed to start scanner. Please check camera permissions.';
        errorMessage.style.display = 'block';
      });
    }
    
    // Stop scanner
    function stopScanner() {
      if (isScanning) {
        html5QrCode.stop()
          .then(() => {
            isScanning = false;
            startScanButton.style.display = 'block';
            stopScanButton.style.display = 'none';
          })
          .catch(err => {
            console.error('Failed to stop scanner:', err);
          });
      }
    }
    
    // Handle successful scan
    function onScanSuccess(riderId) {
      // Play success sound
      const successSound = new Audio('data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAGUACFhYWFhYWFhYWFhYWFhYWFhYWFvb29vb29vb29vb29vb29vb29vb3f39/f39/f39/f39/f39/f39/f3////////////////wAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQCkAAAAAAAAAZQOGZkbgAAAAAAAAAAAAAAAAD/+xDEAAAHMAN/tAAAIgZIb/Z4ABIEAAFYIAAT8ogAAhHxQQEBAQE3d3cRI3cQEMuBAQx3EBAQEiIAAAAAAAxn///+AgICAgRERERERIiIiIiJVVVVVVV3d3d3d3e7u7u7u7vd3d3d3d4AAAABAQAQCBAAAAAAAAAAAAAAAAA=');
      successSound.play();
      
      // Stop scanner
      stopScanner();
      
      // Process the QR code result
      checkInEmployee(riderId.trim());
    }
    
    // Handle scan errors
    function onScanFailure(error) {
      // We don't need to show every scan failure
      console.log(`QR Code scanning failure: ${error}`);
    }
    
    // Check in an employee
    async function checkInEmployee(riderId, location = 'Bus Stop', note = '') {
      // Hide previous messages
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      
      // First, make sure the driver is checked in using the global function from driver-checkin.js
      if (!window.isDriverCheckedIn()) {
        errorMessage.textContent = 'You must check in before you can check in employees.';
        errorMessage.style.display = 'block';
        return;
      }
      
      // Validate employee ID
      if (!riderId || riderId.length !== 5 || !/^\d+$/.test(riderId)) {
        errorMessage.textContent = 'Invalid employee ID. Please enter a valid 5-digit ID.';
        errorMessage.style.display = 'block';
        return;
      }
      
      const checkInData = {
        riderId,
        location,
        note: note || undefined
      };
      
      try {
        // Send API request
        const response = await fetch('/api/direct-trips', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(checkInData)
        });
        
        if (response.ok) {
          // Success
          const trip = await response.json();
          console.log('Check-in successful:', trip);
          
          // Show success message
          successMessage.textContent = `Employee ${trip.riderId} has been successfully checked in!`;
          successMessage.style.display = 'block';
          
          // Update trip details
          tripId.textContent = trip.id;
          tripEmployee.textContent = trip.riderId;
          tripLocation.textContent = trip.location;
          tripTime.textContent = formatDateTime(trip.timestamp);
          tripNote.textContent = trip.note || 'No note provided';
          
          // Show trip details
          tripDetails.style.display = 'block';
          
          // Refresh recent check-ins
          fetchRecentCheckIns();
          
          // Reset form if it was a manual entry
          if (manualTab.classList.contains('active')) {
            checkInForm.reset();
          }
        } else {
          // API error
          const errorData = await response.json();
          console.error('Check-in failed:', errorData);
          
          // Show error message
          errorMessage.textContent = errorData.message || 'Failed to check in employee. Please try again.';
          errorMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = 'An error occurred. Please check your connection and try again.';
        errorMessage.style.display = 'block';
      }
    }
    
    // Render trip history
    function renderTripHistory(trips) {
      if (!trips || trips.length === 0) {
        tripsContainer.innerHTML = '<div class="no-trips">No recent check-ins found</div>';
        return;
      }
      
      // Create table
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Employee ID</th>
            <th>Location</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="trip-list"></tbody>
      `;
      
      const tripList = table.querySelector('#trip-list');
      
      // Add trips to table
      trips.forEach(trip => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatDateTime(trip.timestamp)}</td>
          <td>${trip.riderId}</td>
          <td>${trip.location}</td>
          <td>${trip.note || '-'}</td>
        `;
        tripList.appendChild(row);
      });
      
      tripsContainer.innerHTML = '';
      tripsContainer.appendChild(table);
    }
    
    // Fetch recent check-ins
    async function fetchRecentCheckIns() {
      try {
        const response = await fetch('/api/trips/recent', { credentials: 'include' });
        
        if (response.ok) {
          const trips = await response.json();
          renderTripHistory(trips);
        } else {
          tripsContainer.innerHTML = '<div class="no-trips">Failed to load recent check-ins</div>';
        }
      } catch (error) {
        console.error('Error fetching recent check-ins:', error);
        tripsContainer.innerHTML = '<div class="no-trips">Failed to load recent check-ins</div>';
      }
    }
    
    // Check driver status
    async function checkDriverStatus() {
      try {
        const response = await fetch(`/api/drivers/${currentUser.id}/status`, { credentials: 'include' });
        
        if (response.ok) {
          driverStatus = await response.json();
          console.log('Driver status:', driverStatus);
          
          // Update UI based on driver status
          updateDriverStatusUI();
        } else {
          console.error('Failed to fetch driver status');
          driverStatus = { isCheckedIn: false };
          updateDriverStatusUI();
        }
      } catch (error) {
        console.error('Error checking driver status:', error);
        driverStatus = { isCheckedIn: false };
        updateDriverStatusUI();
      }
    }
    
    // Update driver status UI
    function updateDriverStatusUI() {
      // Update status indicator
      if (driverStatus.isCheckedIn) {
        driverStatusIndicator.textContent = 'Checked In';
        driverStatusIndicator.className = 'status-indicator active';
        driverStatusIndicator.style.backgroundColor = '#dcfce7';
        driverStatusIndicator.style.color = '#166534';
        
        // Show checked-in controls, hide checked-out controls
        driverCheckedInControls.style.display = 'block';
        driverCheckedOutControls.style.display = 'none';
        
        // Show scanning panel
        scanningPanel.style.display = 'block';
        
        // Update check-in time display
        if (driverStatus.lastCheckInTime) {
          checkInTimeDisplay.textContent = formatDateTime(driverStatus.lastCheckInTime);
        }
      } else {
        driverStatusIndicator.textContent = 'Checked Out';
        driverStatusIndicator.className = 'status-indicator inactive';
        driverStatusIndicator.style.backgroundColor = '#fee2e2';
        driverStatusIndicator.style.color = '#b91c1c';
        
        // Show checked-out controls, hide checked-in controls
        driverCheckedOutControls.style.display = 'block';
        driverCheckedInControls.style.display = 'none';
        
        // Hide scanning panel
        scanningPanel.style.display = 'none';
      }
    }
    
    // Driver check-in - this function now calls the global function from driver-checkin.js
    async function driverCheckIn() {
      try {
        const location = checkInLocation.value.trim();
        const note = checkInNote.value.trim();
        
        if (!location) {
          errorMessage.textContent = 'Please enter your current location';
          errorMessage.style.display = 'block';
          return;
        }
        
        // Call the external driver check-in function
        if (typeof window.checkInDriver !== 'function') {
          console.error('window.checkInDriver is not a function', window.checkInDriver);
          errorMessage.textContent = 'Driver check-in functionality not available';
          errorMessage.style.display = 'block';
          return;
        }
        
        const result = await window.checkInDriver(currentUser.id, location, note || '');
        
        if (result) {
          // External function will handle status updates
          successMessage.textContent = 'You have been successfully checked in!';
          successMessage.style.display = 'block';
          errorMessage.style.display = 'none';
          
          // Update the local driverStatus from the window object
          if (window.driverStatus && typeof window.driverStatus === 'object') {
            driverStatus = window.driverStatus;
            // Force a check of driver status to update UI
            await checkDriverStatus();
          }
        } else {
          errorMessage.textContent = 'Failed to check in. Please try again.';
          errorMessage.style.display = 'block';
          successMessage.style.display = 'none';
        }
      } catch (error) {
        console.error('Error during driver check-in:', error);
        errorMessage.textContent = 'An error occurred during check-in. Please try again.';
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
      }
    }
    
    // Driver check-out - this function now calls the global function from driver-checkin.js
    async function driverCheckOut() {
      try {
        // Call the external driver check-out function
        if (typeof window.checkOutDriver !== 'function') {
          console.error('window.checkOutDriver is not a function', window.checkOutDriver);
          errorMessage.textContent = 'Driver check-out functionality not available';
          errorMessage.style.display = 'block';
          return;
        }
        
        const result = await window.checkOutDriver(currentUser.id);
        
        if (result) {
          // External function will handle status updates
          successMessage.textContent = 'You have been successfully checked out!';
          successMessage.style.display = 'block';
          errorMessage.style.display = 'none';
          
          // Update the local driverStatus from the window object
          if (window.driverStatus && typeof window.driverStatus === 'object') {
            driverStatus = window.driverStatus;
            // Force a check of driver status to update UI
            await checkDriverStatus();
          }
          
          // Stop scanner if running
          if (isScanning) {
            stopScanner();
          }
        } else {
          errorMessage.textContent = 'Failed to check out. Please try again.';
          errorMessage.style.display = 'block';
          successMessage.style.display = 'none';
        }
      } catch (error) {
        console.error('Error during driver check-out:', error);
        errorMessage.textContent = 'An error occurred during check-out. Please try again.';
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
      }
    }
    
    // Check if user is logged in
    async function checkAuth() {
      try {
        // Check for cookies that indicate a previous successful login
        if (document.cookie.includes('loginComplete=true') && document.cookie.includes('userType=driver')) {
          console.log('Found login cookie, proceeding with authentication check...');
        }
        
        console.log('Checking authentication status...');
        // Add a timestamp parameter to prevent caching
        const timestamp = new Date().getTime();
        
        // Make the auth check with explicit cache prevention
        const response = await fetch('/api/auth/me?nocache=' + timestamp, { 
          credentials: 'include',
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        // If auth check fails, clear cookies and redirect to login
        if (!response.ok) {
          console.log('Not authenticated, redirecting to login page...');
          // Clear all authentication cookies
          document.cookie = "loginComplete=false; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
          document.cookie = "userType=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
          document.cookie = "userId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
          
          // Redirect with cache-busting parameter
          window.location.replace('/login.html?error=auth_failed&ts=' + timestamp);
          return;
        }
        
        // Parse the user data from the response
        currentUser = await response.json();
        console.log('Authentication successful:', currentUser);
        
        // Set cookies to mark authentication success
        document.cookie = "loginComplete=true; path=/; max-age=3600";
        document.cookie = "userType=" + currentUser.userType + "; path=/; max-age=3600";
        document.cookie = "userId=" + currentUser.id + "; path=/; max-age=3600";
        
        // Make sure the user is a driver
        if (currentUser.userType !== 'driver') {
          alert('This page is for drivers only');
          window.location.href = '/index.html';
          return;
        }
        
        // Update welcome message
        welcomeMessage.textContent = `Welcome, ${currentUser.name}!`;
        
        // Initialize QR scanner
        initQrScanner();
        
        // Check driver status
        await checkDriverStatus();
        
        // Fetch recent check-ins
        fetchRecentCheckIns();
        
        // Setup driver check-in/check-out event handlers
        driverCheckInBtn.addEventListener('click', driverCheckIn);
        driverCheckOutBtn.addEventListener('click', driverCheckOut);
      } catch (error) {
        console.error('Error checking authentication:', error);
        window.location.href = '/login.html';
      }
    }
    
    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Stop scanner when switching tabs
        if (isScanning && tab.dataset.tab !== 'scan') {
          stopScanner();
        }
        
        // Deactivate all tabs
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Activate selected tab
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Handle manual check-in form submission
    checkInForm.addEventListener('submit', e => {
      e.preventDefault();
      
      const formData = new FormData(checkInForm);
      checkInEmployee(
        formData.get('riderId'),
        formData.get('location'),
        formData.get('note')
      );
    });
    
    // Handle manual QR code input
    qrManualSubmit.addEventListener('click', () => {
      const riderId = qrManualInput.value.trim();
      if (riderId) {
        checkInEmployee(riderId);
        qrManualInput.value = ''; // Clear the input field
      } else {
        errorMessage.textContent = 'Please enter a valid Employee ID';
        errorMessage.style.display = 'block';
      }
    });
    
    // Allow pressing Enter in the manual QR input
    qrManualInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        qrManualSubmit.click();
      }
    });
    
    // Handle logout
    logoutButton.addEventListener('click', async () => {
      // Stop scanner if running
      if (isScanning) {
        stopScanner();
      }
      
      try {
        console.log('Logging out...');
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        console.log('Logged out successfully, redirecting to login page...');
        
        // Use replace for redirection to avoid history issues
        window.location.replace('/login.html');
      } catch (error) {
        console.error('Error logging out:', error);
      }
    });
    
    // Initialize
    checkAuth();
    
    // Initialize location tracking elements here - driver-location.js will auto-initialize
    // but we need to make sure it's properly loaded and can find all the DOM elements
    if (typeof window.driverLocationTracker === 'undefined') {
      console.warn('Driver location tracking not available. Make sure driver-location.js is loaded correctly.');
    }
  </script>
  <!-- External scripts -->
  <script src="/js/html5-qrcode.min.js"></script>
  <script src="/js/driver-checkin.js"></script>
  <script src="/js/driver-location.js"></script>
</body>
</html>