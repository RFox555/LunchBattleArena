<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Check-In</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      font-size: 32px;
      margin-right: 10px;
    }
    .heading {
      display: flex;
      align-items: center;
    }
    h1 {
      margin: 0;
      color: #2563eb;
      font-size: 24px;
    }
    .logout-button {
      background-color: #f3f4f6;
      color: #4b5563;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .welcome {
      font-size: 18px;
      margin-bottom: 15px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    .tab.active {
      border-bottom-color: #2563eb;
      color: #2563eb;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .scanner-container {
      margin: 20px 0;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 8px;
      overflow: hidden;
    }
    .button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 0;
    }
    .button:hover {
      background-color: #1d4ed8;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    .success-message {
      background-color: #dcfce7;
      border: 1px solid #86efac;
      color: #166534;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
    .error-message {
      background-color: #fee2e2;
      border: 1px solid #fca5a5;
      color: #b91c1c;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }
    .trip-details {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      display: none;
    }
    .detail-row {
      margin-bottom: 8px;
    }
    .detail-label {
      font-weight: bold;
      display: inline-block;
      width: 120px;
    }
    .recent-check-ins {
      margin-top: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th {
      text-align: left;
      border-bottom: 2px solid #e5e7eb;
      padding: 10px 15px;
      font-size: 14px;
      color: #6b7280;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .no-trips {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      font-style: italic;
    }
  </style>
  <!-- Include QR Code Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="heading">
        <div class="logo">ðŸšŒ</div>
        <h1>Driver Check-In</h1>
      </div>
      <button id="logout-button" class="logout-button">Logout</button>
    </header>

    <div class="card">
      <div id="welcome-message" class="welcome">Loading...</div>
      
      <div class="tabs">
        <div class="tab active" data-tab="scan">Scan QR Code</div>
        <div class="tab" data-tab="manual">Manual Entry</div>
      </div>
      
      <div id="scan-tab" class="tab-content active">
        <p>Scan the rider's QR code to check them in:</p>
        <div class="scanner-container">
          <div id="reader"></div>
          <button id="start-scan" class="button">Start Scanner</button>
          <button id="stop-scan" class="button" style="display:none; background-color: #e11d48;">Stop Scanner</button>
          
          <div style="margin-top: 20px; text-align: center;">
            <p>If camera access is not available, you can manually enter the Rider ID below:</p>
            <div style="display: flex; max-width: 300px; margin: 0 auto;">
              <input type="text" id="qr-manual-input" placeholder="Enter Rider ID" style="margin-right: 10px;">
              <button id="qr-manual-submit" class="button" style="width: auto; margin: 0;">Submit</button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="manual-tab" class="tab-content">
        <form id="check-in-form">
          <div class="form-group">
            <label for="rider-id">Rider ID:</label>
            <input type="text" id="rider-id" name="riderId" maxlength="5" pattern="[0-9]{5}" placeholder="Enter 5-digit rider ID" required>
          </div>
          
          <div class="form-group">
            <label for="location">Pickup Location:</label>
            <input type="text" id="location" name="location" value="Bus Stop" required>
          </div>
          
          <div class="form-group">
            <label for="note">Note (Optional):</label>
            <textarea id="note" name="note" placeholder="Add any notes about this trip"></textarea>
          </div>
          
          <button type="submit" class="button">Check In Rider</button>
        </form>
      </div>
      
      <div id="success-message" class="success-message"></div>
      <div id="error-message" class="error-message"></div>
      
      <div id="trip-details" class="trip-details">
        <h2>Trip Details</h2>
        <div class="detail-row">
          <span class="detail-label">Trip ID:</span>
          <span id="trip-id"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Rider ID:</span>
          <span id="trip-rider"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Location:</span>
          <span id="trip-location"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span id="trip-time"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Note:</span>
          <span id="trip-note"></span>
        </div>
      </div>
    </div>
    
    <div class="card recent-check-ins">
      <h2>Recent Check-Ins</h2>
      <div id="trips-container">
        <div class="no-trips">Loading recent check-ins...</div>
      </div>
    </div>
  </div>
  
  <script>
    // DOM elements
    const welcomeMessage = document.getElementById('welcome-message');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const scanTab = document.getElementById('scan-tab');
    const manualTab = document.getElementById('manual-tab');
    const checkInForm = document.getElementById('check-in-form');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const tripDetails = document.getElementById('trip-details');
    const tripId = document.getElementById('trip-id');
    const tripRider = document.getElementById('trip-rider');
    const tripLocation = document.getElementById('trip-location');
    const tripTime = document.getElementById('trip-time');
    const tripNote = document.getElementById('trip-note');
    const tripsContainer = document.getElementById('trips-container');
    const logoutButton = document.getElementById('logout-button');
    const startScanButton = document.getElementById('start-scan');
    const stopScanButton = document.getElementById('stop-scan');
    const qrManualInput = document.getElementById('qr-manual-input');
    const qrManualSubmit = document.getElementById('qr-manual-submit');
    
    // Current user data
    let currentUser = null;
    
    // QR Code scanner
    let html5QrCode;
    let isScanning = false;
    
    // Format date and time
    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString();
    }
    
    // Initialize QR Code scanner
    function initQrScanner() {
      html5QrCode = new Html5Qrcode("reader");
      
      startScanButton.addEventListener('click', startScanner);
      stopScanButton.addEventListener('click', stopScanner);
    }
    
    // Start scanner
    function startScanner() {
      const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };
      
      html5QrCode.start(
        { facingMode: "environment" },
        qrConfig,
        onScanSuccess,
        onScanFailure
      )
      .then(() => {
        isScanning = true;
        startScanButton.style.display = 'none';
        stopScanButton.style.display = 'block';
      })
      .catch(err => {
        console.error('Failed to start scanner:', err);
        errorMessage.textContent = 'Failed to start scanner. Please check camera permissions.';
        errorMessage.style.display = 'block';
      });
    }
    
    // Stop scanner
    function stopScanner() {
      if (isScanning) {
        html5QrCode.stop()
          .then(() => {
            isScanning = false;
            startScanButton.style.display = 'block';
            stopScanButton.style.display = 'none';
          })
          .catch(err => {
            console.error('Failed to stop scanner:', err);
          });
      }
    }
    
    // Handle successful scan
    function onScanSuccess(riderId) {
      // Play success sound
      const successSound = new Audio('data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAGUACFhYWFhYWFhYWFhYWFhYWFhYWFvb29vb29vb29vb29vb29vb29vb3f39/f39/f39/f39/f39/f39/f3////////////////wAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQCkAAAAAAAAAZQOGZkbgAAAAAAAAAAAAAAAAD/+xDEAAAHMAN/tAAAIgZIb/Z4ABIEAAFYIAAT8ogAAhHxQQEBAQE3d3cRI3cQEMuBAQx3EBAQEiIAAAAAAAxn///+AgICAgRERERERIiIiIiJVVVVVVV3d3d3d3e7u7u7u7vd3d3d3d4AAAABAQAQCBAAAAAAAAAAAAAAAAA=');
      successSound.play();
      
      // Stop scanner
      stopScanner();
      
      // Process the QR code result
      checkInRider(riderId.trim());
    }
    
    // Handle scan errors
    function onScanFailure(error) {
      // We don't need to show every scan failure
      console.log(`QR Code scanning failure: ${error}`);
    }
    
    // Check in a rider
    async function checkInRider(riderId, location = 'Bus Stop', note = '') {
      // Hide previous messages
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      
      // Validate rider ID
      if (!riderId || riderId.length !== 5 || !/^\d+$/.test(riderId)) {
        errorMessage.textContent = 'Invalid rider ID. Please enter a valid 5-digit ID.';
        errorMessage.style.display = 'block';
        return;
      }
      
      const checkInData = {
        riderId,
        location,
        note: note || undefined
      };
      
      try {
        // Send API request
        const response = await fetch('/api/direct-trips', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(checkInData)
        });
        
        if (response.ok) {
          // Success
          const trip = await response.json();
          console.log('Check-in successful:', trip);
          
          // Show success message
          successMessage.textContent = `Rider ${trip.riderId} has been successfully checked in!`;
          successMessage.style.display = 'block';
          
          // Update trip details
          tripId.textContent = trip.id;
          tripRider.textContent = trip.riderId;
          tripLocation.textContent = trip.location;
          tripTime.textContent = formatDateTime(trip.timestamp);
          tripNote.textContent = trip.note || 'No note provided';
          
          // Show trip details
          tripDetails.style.display = 'block';
          
          // Refresh recent check-ins
          fetchRecentCheckIns();
          
          // Reset form if it was a manual entry
          if (manualTab.classList.contains('active')) {
            checkInForm.reset();
          }
        } else {
          // API error
          const errorData = await response.json();
          console.error('Check-in failed:', errorData);
          
          // Show error message
          errorMessage.textContent = errorData.message || 'Failed to check in rider. Please try again.';
          errorMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = 'An error occurred. Please check your connection and try again.';
        errorMessage.style.display = 'block';
      }
    }
    
    // Render trip history
    function renderTripHistory(trips) {
      if (!trips || trips.length === 0) {
        tripsContainer.innerHTML = '<div class="no-trips">No recent check-ins found</div>';
        return;
      }
      
      // Create table
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Rider ID</th>
            <th>Location</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="trip-list"></tbody>
      `;
      
      const tripList = table.querySelector('#trip-list');
      
      // Add trips to table
      trips.forEach(trip => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatDateTime(trip.timestamp)}</td>
          <td>${trip.riderId}</td>
          <td>${trip.location}</td>
          <td>${trip.note || '-'}</td>
        `;
        tripList.appendChild(row);
      });
      
      tripsContainer.innerHTML = '';
      tripsContainer.appendChild(table);
    }
    
    // Fetch recent check-ins
    async function fetchRecentCheckIns() {
      try {
        const response = await fetch('/api/trips/recent', { credentials: 'include' });
        
        if (response.ok) {
          const trips = await response.json();
          renderTripHistory(trips);
        } else {
          tripsContainer.innerHTML = '<div class="no-trips">Failed to load recent check-ins</div>';
        }
      } catch (error) {
        console.error('Error fetching recent check-ins:', error);
        tripsContainer.innerHTML = '<div class="no-trips">Failed to load recent check-ins</div>';
      }
    }
    
    // Check if user is logged in
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        
        if (!response.ok) {
          // Not logged in, redirect to login
          window.location.href = '/login';
          return;
        }
        
        currentUser = await response.json();
        
        // Make sure the user is a driver
        if (currentUser.userType !== 'driver') {
          alert('This page is for drivers only');
          window.location.href = '/';
          return;
        }
        
        // Update welcome message
        welcomeMessage.textContent = `Welcome, ${currentUser.name}!`;
        
        // Initialize QR scanner
        initQrScanner();
        
        // Fetch recent check-ins
        fetchRecentCheckIns();
      } catch (error) {
        console.error('Error checking authentication:', error);
        window.location.href = '/login';
      }
    }
    
    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Stop scanner when switching tabs
        if (isScanning && tab.dataset.tab !== 'scan') {
          stopScanner();
        }
        
        // Deactivate all tabs
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Activate selected tab
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Handle manual check-in form submission
    checkInForm.addEventListener('submit', e => {
      e.preventDefault();
      
      const formData = new FormData(checkInForm);
      checkInRider(
        formData.get('riderId'),
        formData.get('location'),
        formData.get('note')
      );
    });
    
    // Handle manual QR code input
    qrManualSubmit.addEventListener('click', () => {
      const riderId = qrManualInput.value.trim();
      if (riderId) {
        checkInRider(riderId);
        qrManualInput.value = ''; // Clear the input field
      } else {
        errorMessage.textContent = 'Please enter a valid Rider ID';
        errorMessage.style.display = 'block';
      }
    });
    
    // Allow pressing Enter in the manual QR input
    qrManualInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        qrManualSubmit.click();
      }
    });
    
    // Handle logout
    logoutButton.addEventListener('click', async () => {
      // Stop scanner if running
      if (isScanning) {
        stopScanner();
      }
      
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/login';
      } catch (error) {
        console.error('Error logging out:', error);
      }
    });
    
    // Initialize
    checkAuth();
  </script>
</body>
</html>